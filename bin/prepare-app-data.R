#!/usr/bin/env Rscript

# prepare data for app
library(vroom)
library(dplyr)
library(ivs)
library(stringr)

source('R/global.R')

siformat <- function(x) {system2('bin/siformat.sh', args = x, stdout = T)}

processed_files <- list.files('data', pattern = 'grid.csv|prom.csv', full.names = T, recursive = F)
count_files <- list.files('data', pattern = 'counts.csv', full.names = T, recursive = F)
pb_dump_files <- list.files('data', pattern = 'smrtlink_dump_LATEST_', full.names = T, recursive = F)

pis <- vroom('data/pis.tsv')

# PacBio dump data
df_pb <- map_df(pb_dump_files, ~vroom(.x, col_select = all_of(pb_columns)))

df_pb <- 
  df_pb %>% 
  mutate(px = str_extract(string = str_c(run_name, cell_name, sep = "_"), pattern = '(?<=_)P[0-9]{1,2}')) %>% 
  # fix non-conformant runs
  mutate(
    px = case_when(
      str_detect(run_name, '_Peng') ~ 'P8', 
      str_detect(run_name, '_Sara') ~ 'P1',
      str_detect(run_name, '_Damien') ~ 'P27',
      str_detect(run_name, 'SAT_') ~ 'P0',
      str_detect(run_name, 'Training') ~ 'P0',
      TRUE ~ px)
    ) %>%
  left_join(pis, by = c('px' = 'pi')) %>%
  # these are factors to enable color assignment
  mutate(division = factor(division), pi_portal = factor(pi_portal))

divisions <- setNames(
    levels(df_pb$division), 
    my_levels_color(length(levels(df_pb$division)))
    ) %>% 
  stack()


df_pb <- 
  df_pb %>% 
  left_join(divisions, by = c('division' = 'values')) %>% 
  mutate(style_division = paste0('background-color: ', ind, ';'))
  
# fix 1 wrong run enddate
df_pb[df_pb$run_uniqueId == '12d845e8-54f1-40d0-9580-f4a173023ae3',]$run_completedAt <- as_datetime("2019-05-06 08:36:59 UTC")
write.csv(df_pb, file = 'data/df_pb.csv', row.names = F)

df1 <- vroom(processed_files) %>% 
  dplyr::distinct() %>%
  mutate(type = 'range') %>%
  rowwise() %>% 
  mutate(
    id = run_id, 
    flowcell_id = str_c(content, "_", str_extract(string = run_id, pattern = "^[a-z0-9]{8}(?=-)")) # gives e.g. FAR33076_074e9094
    )
#mutate(id = digest(rnorm(1)))
# create id



df2 <- vroom(count_files, 
             col_names = c('file', 'bases_pass', 'bases_fail', 
                           'reads_pass', 'reads_fail', 
                           'nx_pass', 'nx_fail', 'mean_qscore')
             ) %>%
  # get flowcell + runid generated by MinKNOW and use for joining
  mutate(
    flowcell_id = str_extract(string = file, pattern = "(?<=_)[A-Z]{3}[0-9]{3,5}_[a-z0-9]{8}(?=\\/)"), # gives e.g. FAR33076_074e9094
    px = str_extract(string = file, pattern = "(?<=_)P[0-9]{1,2}[PU][0-9]{1,2}"),
    pi = str_extract(string = px, pattern = "P[0-9]{1,2}") # PI only to join to pis
    ) %>%
  mutate(file = basename(file)) %>%
  dplyr::distinct() %>%
  mutate(ratio = bases_fail/bases_pass, 
         style_failed = paste0('background-color: ', my_temp_color(ratio, 1, 0), ';'),
         style_qscore = paste0('background-color: ', my_temp_color(mean_qscore, 0, 22), ';'),
         style_nx = paste0('background-color: ', my_temp_color(nx_pass, 0, 30000), ';')
         ) %>%
  left_join(pis)

  # mutate(flowcell = str_extract(string = file, pattern = '(?<=summary_)[A-Z]+[0-9]+'))
  # pi = str_extract(string = file, pattern = "(?<=_)P[0-9]+[PU][0-9]+")

df <- df1 %>% 
  left_join(df2, by = c('seq_summary_file' = 'file'), multiple = 'first') %>%
  mutate(title = paste0(
    siformat(bases_pass), ' bases | ', 
    siformat(reads_pass), ' reads | ',
    round(ratio * 100, 0), '% failed | ',
    'qscore ', mean_qscore, ' | N50 ', nx_pass 
  )
  ) %>%
  arrange(start)

# dfmerged <- df %>%
#   merge_overlaps(start, end, group)

write.csv(df, file = 'data/df.csv', row.names = F)
#saveRDS(dfmerged, file = 'data/dfmerged.rds')

