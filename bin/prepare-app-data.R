#!/usr/bin/env Rscript

# prepare data for app
library(vroom)
library(dplyr)
library(ivs)
library(stringr)

source('R/global.R')

siformat <- function(x) {system2('bin/siformat.sh', args = x, stdout = T)}

processed_files <- list.files('data', pattern = 'grid.csv|prom.csv', full.names = T, recursive = F)
count_files <- list.files('data', pattern = 'counts.csv', full.names = T, recursive = F)

df1 <- vroom(processed_files) %>% 
  dplyr::distinct() %>%
  mutate(type = 'range') %>%
  rowwise() %>% 
  mutate(
    id = run_id, 
    flowcell_id = str_c(content, "_", str_extract(string = run_id, pattern = "^[a-z0-9]{8}(?=-)")) # gives e.g. FAR33076_074e9094
    )
#mutate(id = digest(rnorm(1)))
# create id



df2 <- vroom(count_files, 
             col_names = c('file', 'bases_pass', 'bases_fail', 
                           'reads_pass', 'reads_fail', 
                           'nx_pass', 'nx_fail', 'mean_qscore')
             ) %>%
  # get flowcell + runid generated by MinKNOW and use for joining
  mutate(
    flowcell_id = str_extract(string = file, pattern = "(?<=_)[A-Z]{3}[0-9]{3,5}_[a-z0-9]{8}(?=\\/)"), # gives e.g. FAR33076_074e9094
    pi = str_extract(string = file, pattern = "P[0-9]{1,2}[PU][0-9]{1,2}")) %>%
  #mutate(file = basename(file)) %>%
  dplyr::distinct() %>%
  mutate(ratio = bases_fail/bases_pass, 
         style_failed = paste0('background-color: ', my_temp_color(ratio, 0, 1), ';'),
         style_qscore = paste0('background-color: ', my_temp_color(mean_qscore, 20, 0), ';')
         ) 
  # mutate(flowcell = str_extract(string = file, pattern = '(?<=summary_)[A-Z]+[0-9]+'))
  # pi = str_extract(string = file, pattern = "(?<=_)P[0-9]+[PU][0-9]+")

df <- df1 %>% 
  left_join(df2, multiple = 'first') %>%
  mutate(title = paste0(
    siformat(bases_pass), ' bases | ', 
    siformat(reads_pass), ' reads | ',
    round(ratio * 100, 0), '% failed | ',
    'qscore ', mean_qscore, ' | N50 ', nx_pass 
  )
  ) %>%
  arrange(start)

# dfmerged <- df %>%
#   merge_overlaps(start, end, group)

write.csv(df, file = 'data/df.csv', row.names = F)
#saveRDS(dfmerged, file = 'data/dfmerged.rds')

